import ast
import json
from pathlib import Path
from typing import Dict, List, Union
import typer
from rich.console import Console

app = typer.Typer()
console = Console()

EXCLUDED_LOGGER_NAMES = {"logger", "logging"}

class FunctionUsageCounter(ast.NodeVisitor):
    def __init__(self, target_funcs: List[str]) -> None:
        self.target_funcs = set(target_funcs)
        self.counts = {func: 0 for func in target_funcs}

    def visit_Call(self, node: ast.Call) -> None:
        func_name = self._resolve_func_name(node.func)
        if func_name in self.target_funcs:
            self.counts[func_name] += 1
        self.generic_visit(node)

    def _resolve_func_name(self, node: ast.AST) -> Union[str, None]:
        # Handles obj.get_d() and get_d()
        if isinstance(node, ast.Name):
            return node.id
        elif isinstance(node, ast.Attribute):
            return node.attr
        return None

    def visit_Expr(self, node: ast.Expr) -> None:
        # Skip logging calls
        if isinstance(node.value, ast.Call):
            func = node.value.func
            if isinstance(func, ast.Attribute) and isinstance(func.value, ast.Name):
                if func.value.id in EXCLUDED_LOGGER_NAMES:
                    return  # Skip logger calls
        self.generic_visit(node)

    def visit_Str(self, node):
        pass  # skip string literals

    def visit_Constant(self, node):
        if isinstance(node.value, str):
            return  # skip docstrings / constants
        self.generic_visit(node)


def count_functions_in_file(file_path: Path, target_funcs: List[str]) -> Dict[str, int]:
    try:
        tree = ast.parse(file_path.read_text())
    except Exception as e:
        console.print(f"[red]‚ùå Failed parsing {file_path}[/red]: {e}")
        return {func: 0 for func in target_funcs}

    counter = FunctionUsageCounter(target_funcs)
    counter.visit(tree)
    return counter.counts


@app.command()
def count_usage_from_file(
    config_path: Path = typer.Argument(..., help="Path to input JSON file with repos, folder, and function list")
):
    """Counts function usage in specified repos and folder, updates counts in the same JSON file."""
    data = json.loads(config_path.read_text())
    target_funcs = list(data.get("counts", {}).keys())
    repos = data.get("repos", [])
    folder = data.get("folder", "")

    if not target_funcs or not repos or not folder:
        console.print("[red]‚ùå Invalid JSON input. Ensure it has 'repos', 'folder', and 'counts'.[/red]")
        raise typer.Exit(1)

    total_counts = {func: 0 for func in target_funcs}

    for repo_name in repos:
        console.print(f"[blue]üîç Scanning:[/blue] {repo_name}/{folder}")
        repo_path = Path("repos") / repo_name.replace("/", "_")
        target_dir = repo_path / folder

        if not target_dir.exists():
            console.print(f"[red]‚ùå Folder not found:[/red] {target_dir}")
            continue

        for file in target_dir.rglob("*.py"):
            file_counts = count_functions_in_file(file, target_funcs)
            for func in target_funcs:
                total_counts[func] += file_counts[func]

    data["counts"] = total_counts
    config_path.write_text(json.dumps(data, indent=2))
    console.print("[green]‚úÖ Updated counts saved in:[/green]", config_path)


if __name__ == "__main__":
    app()