from openpyxl import load_workbook
from openpyxl.styles import Font, Alignment, PatternFill
from openpyxl.utils import get_column_letter
from pathlib import Path

def style_existing_excel(file_path: Path, sheets: list[str] = None) -> None:
    """Apply formatting styles to specified sheets in an existing Excel file."""
    
    wb = load_workbook(file_path)

    target_sheets = sheets or wb.sheetnames  # if no sheets specified, format all

    for sheet_name in target_sheets:
        if sheet_name not in wb.sheetnames:
            print(f"⚠️ Sheet not found: {sheet_name}")
            continue

        ws = wb[sheet_name]
        ws.freeze_panes = "A2"

        # --- Style headers ---
        header_fill = PatternFill("solid", fgColor="DDEEFF")  # light blue
        for cell in ws[1]:
            cell.font = Font(bold=True)
            cell.fill = header_fill
            cell.alignment = Alignment(horizontal="center", vertical="center", wrap_text=True)

        # --- Auto-adjust column widths ---
        for col in ws.columns:
            max_len = max((len(str(cell.value)) for cell in col if cell.value is not None), default=10)
            col_letter = get_column_letter(col[0].column)
            ws.column_dimensions[col_letter].width = min(max_len + 4, 60)

        # --- Wrap text in all data rows ---
        for row in ws.iter_rows(min_row=2):
            for cell in row:
                if isinstance(cell.value, str) and ("," in cell.value or "[" in cell.value or len(cell.value) > 30):
                    cell.alignment = Alignment(wrap_text=True)

    wb.save(file_path)
    print(f"✅ Styled existing Excel: {file_path}")